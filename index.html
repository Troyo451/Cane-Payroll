<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cane Cut Record</title>
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      h2 {
        color: #333;
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-top: 15px;
        font-size: 1.1em;
        color: #555;
      }
      input, select {
        width: calc(100% - 20px);
        max-width: 300px;
        font-size: 1.3em;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
      }
      button {
        width: calc(100% - 20px);
        max-width: 300px;
        font-size: 1.6em;
        padding: 15px;
        margin-top: 25px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      button:active {
        background-color: #45a049;
        box-shadow: none;
      }
      #status {
        margin-top: 30px;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
        width: calc(100% - 40px);
        max-width: 300px;
        background-color: #e0e0e0;
        color: #333;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .online-status {
        background-color: #d4edda;
        color: #155724;
      }
      .offline-status {
        background-color: #f8d7da;
        color: #721c24;
      }
      .pending-sync-status {
        background-color: #fff3cd;
        color: #856404;
      }
    </style>
    <!-- Supabase client CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script>
    <script type="module" src="./supabase.js"></script>
  </head>
  <body>
    <h2>Cutting Record</h2>

    <label for="cutDate">Date of Cut:</label>
    <input type="date" id="cutDate">

    <label for="cutterId">Cutter ID:</label>
    <select id="cutterId">
      <option value="">Loading Cutters...</option>
    </select>

    <label for="tonsCut">Tons Cut (Tons):</label>
    <input type="number" id="tonsCut" min="0" step="0.1" placeholder="e.g., 5.5">

    <button onclick="submitForm()">Submit Cut</button>

    <div id="status">Checking connection...</div>

    <script type="module">
      import { supabase } from './supabase.js';

      document.addEventListener('DOMContentLoaded', () => {
        updateStatus();
        loadCutterData();
        syncOfflineData();
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        window.addEventListener('online', syncOfflineData);
      });

      function isOnline() {
        return navigator.onLine;
      }

      function updateStatus() {
        const statusElement = document.getElementById('status');
        const pendingCount = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]').length;
        if (isOnline()) {
          if (pendingCount > 0) {
            statusElement.textContent = `Online (${pendingCount} pending sync)`;
            statusElement.className = 'pending-sync-status';
          } else {
            statusElement.textContent = 'Online ✅';
            statusElement.className = 'online-status';
          }
        } else {
          statusElement.textContent = `Offline ❌ (${pendingCount} pending)`;
          statusElement.className = 'offline-status';
        }
      }

      // Fetches cutter names and IDs from Supabase and populates the dropdown
      async function loadCutterData() {
        const select = document.getElementById('cutterId');
        select.innerHTML = '<option value="">Loading Cutters...</option>';
        const { data, error } = await supabase
          .from('canecutters')
          .select('cutter_id, name, surname');
        select.innerHTML = '<option value="">Select Cutter</option>';
        if (error) {
          console.error('Error loading cutters:', error.message);
          select.innerHTML = '<option value="">Error loading cutters. Please refresh.</option>';
          alert('Error loading cutters: ' + error.message);
          return;
        }
        if (data && data.length > 0) {
          data.forEach(cutter => {
            const option = document.createElement('option');
            option.value = cutter.cutter_id;
            option.textContent = cutter.name + ' ' + cutter.surname;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">No cutters found</option>';
        }
      }

      window.submitForm = async function() {
        const date = document.getElementById('cutDate').value;
        const cutterId = document.getElementById('cutterId').value;
        const tons = document.getElementById('tonsCut').value;
        if (!date) {
          alert('Please select a Date of Cut.');
          return;
        }
        if (!cutterId) {
          alert('Please select a Cutter ID.');
          return;
        }
        if (!tons || isNaN(parseFloat(tons)) || parseFloat(tons) <= 0) {
          alert('Please enter a valid amount of Tons Cut (must be a number greater than 0).');
          return;
        }
        const submission = {
          type: 'dailyCut',
          dateOfCut: date,
          cutterId: cutterId,
          tonsCut: parseFloat(tons)
        };
        if (isOnline()) {
          // Insert into Supabase
          const { error } = await supabase.from('dailycuts').insert([
            {
              date_of_cut: submission.dateOfCut,
              cutter_id: submission.cutterId,
              tons_cut: submission.tonsCut
            }
          ]);
          if (!error) {
            alert('Daily cut recorded successfully!');
            updateStatus();
          } else {
            alert('Server error: ' + error.message + ' It has been queued for offline sync.');
            saveToOfflineQueue(submission);
            updateStatus();
          }
        } else {
          saveToOfflineQueue(submission);
          alert('Offline: Data saved locally. It will sync automatically when you are back online.');
        }
        document.getElementById('cutDate').value = '';
        document.getElementById('cutterId').value = '';
        document.getElementById('tonsCut').value = '';
        updateStatus();
      }

      function saveToOfflineQueue(item) {
        let queue = JSON.parse(localStorage.getItem('offlineSubmissions')) || [];
        queue.push(item);
        localStorage.setItem('offlineSubmissions', JSON.stringify(queue));
        updateStatus();
      }

      async function syncOfflineData() {
        if (!isOnline()) {
          console.log('Still offline, cannot sync.');
          return;
        }
        let queue = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
        if (queue.length === 0) {
          console.log('No offline data to sync.');
          updateStatus();
          return;
        }
        console.log(`Attempting to sync ${queue.length} offline items.`);
        alert(`Attempting to sync ${queue.length} offline items...`);
        let newQueue = [];
        let syncedCount = 0;
        for (const item of queue) {
          if (item.type === 'dailyCut') {
            const { error } = await supabase.from('dailycuts').insert([
              {
                date_of_cut: item.dateOfCut,
                cutter_id: item.cutterId,
                tons_cut: item.tonsCut
              }
            ]);
            if (!error) {
              syncedCount++;
            } else {
              newQueue.push(item);
              console.error('Failed to sync item:', error.message, item);
            }
          } else {
            newQueue.push(item);
            console.error('Unknown submission type:', item);
          }
        }
        localStorage.setItem('offlineSubmissions', JSON.stringify(newQueue));
        updateStatus();
        if (syncedCount > 0) {
          alert(`Synced ${syncedCount} item(s) successfully!`);
        }
        if (newQueue.length > 0) {
          alert(`Could not sync ${newQueue.length} item(s). They remain in the offline queue.`);
        }
      }
    </script>
    <script>
      // Register service worker for offline/PWA support
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  </body>
</html> 