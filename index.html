<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cane Cut Record</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
      body {
        font-family: sans-serif;
        padding: 20px;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        margin: 0;
      }
      h2 {
        color: #333;
        margin-bottom: 20px;
        text-align: center;
      }
      h3 {
        text-align: center;
      }
      label {
        display: block;
        margin-top: 15px;
        font-size: 1.1em;
        color: #555;
      }
      input, select {
        width: calc(100% - 20px);
        max-width: 300px;
        font-size: 1.3em;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        text-align: right;
      }
      button {
        width: 100%;
        max-width: 300px;
        font-size: 1.6em;
        padding: 15px;
        margin-top: 25px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      button:active {
        background-color: #45a049;
        box-shadow: none;
      }
      #status {
        margin-top: 30px;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
        width: calc(100% - 40px);
        max-width: 300px;
        background-color: #e0e0e0;
        color: #333;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .online-status {
        background-color: #d4edda;
        color: #155724;
      }
      .offline-status {
        background-color: #f8d7da;
        color: #721c24;
      }
      .pending-sync-status {
        background-color: #fff3cd;
        color: #856404;
      }
      .centered-form {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 2000px;
        margin: 0 auto;
        background: #fff;
        padding: 32px 64px 32px 64px;
        border-radius: 12px;
        box-shadow: 0 2px 12px rgba(0,0,0,0.07);
      }
      .admin-dashboard-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
      }
      .landing-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
      }
      .filter-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 8px;
        max-width: 350px;
      }
      .filter-label {
        min-width: 60px;
        text-align: right;
        font-size: 1em;
        color: #555;
      }
      .csv-export-group {
        margin-bottom: 24px;
        padding-bottom: 12px;
        border-bottom: 1px solid #eee;
        max-width: 350px;
        display: flex;
        flex-direction: column;
      }
      .csv-export-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .csv-export-header b {
        font-size: 1.1em;
      }
      .csv-export-btn {
        font-size: 1.1em;
        padding: 4px 14px;
        margin: 0;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        width: auto;
        min-width: 0;
        max-width: none;
      }
      .csv-export-btn:active {
        background-color: #45a049;
        box-shadow: none;
      }
      .config-toggle-buttons {
        display: flex;
        gap: 16px;
        margin-bottom: 18px;
        align-items: flex-start;
        flex-shrink: 0;
      }
      .config-toggle-btn {
        font-size: 1.1em;
        padding: 8px 24px;
        border: none;
        border-radius: 8px;
        background: #e0e0e0;
        color: #333;
        cursor: pointer;
        transition: background 0.2s;
        width: 150px;
        box-sizing: border-box;
        outline: none;
      }
      .config-toggle-btn.active {
        background: #4CAF50;
        color: white;
        outline: none;
      }
      .config-toggle-btn:focus {
        outline: none;
        box-shadow: 0 0 0 2px #2196F3;
      }
      .config-section {
        display: none;
        margin-top: 8px;
      }
      .config-section.active {
        display: block;
      }
      @media (max-width: 600px) {
        .filter-row, .csv-export-group { max-width: 100%; }
      }
      .wage-scale-empty-message {
        max-width: 320px;
        margin: 0 auto;
        text-align: center;
        word-break: break-word;
        white-space: normal;
        color: #555;
        font-size: 1.1em;
      }
      .config-action-btn {
        width: 150px;
        font-size: 1.1em;
        padding: 8px 24px;
        border: none;
        border-radius: 8px;
        background: #4CAF50;
        color: white;
        cursor: pointer;
        transition: background 0.2s;
        box-sizing: border-box;
        margin: 12px 0;
      }
      .config-action-btn:active {
        background: #45a049;
      }
    </style>
    <!-- Supabase client CDN -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm" type="module"></script> -->
    <!-- <script type="module" src="./supabase.js"></script> -->
  </head>
  <body>
    <div id="onlineStatus" style="position:fixed;top:10px;right:10px;z-index:1000;"></div>
    <button id="backToHomeBtn" style="position:fixed;top:10px;left:10px;z-index:1000;display:none;background-color:#e53935;color:white;border:none;border-radius:8px;padding:12px 22px;font-size:1.1em;box-shadow:0 2px 6px rgba(0,0,0,0.12);cursor:pointer;transition:background-color 0.2s;" onclick="showLanding()">Return to home</button>
    <div id="landingView">
      <div class="centered-form">
        <h2>Cane Payroll App</h2>
        <div class="landing-buttons">
          <button onclick="showDataCapture()">Data Capture</button>
          <button onclick="showAdmin()">Admin</button>
        </div>
      </div>
    </div>

    <div id="dataCaptureView" style="display:none;">
      <div class="centered-form">
        <h2>Truck Data Capture</h2>
        <form id="truckForm" onsubmit="return false;">
          <label for="truckNumber">Truck Number:</label>
          <div style="display:flex;justify-content:center;">
            <input type="text" id="truckNumber" required>
          </div>

          <label for="cutDate">Date of Cut:</label>
          <div style="display:flex;justify-content:center;">
            <input type="date" id="cutDateTruck" required>
          </div>

          <label for="fieldNumbers">Field Number(s):</label>
          <div style="display:flex;justify-content:center;">
            <input type="text" id="fieldNumbers" placeholder="e.g., 1,2,3" required>
          </div>

          <div id="cuttersSection">
            <h3>Cutter Weights</h3>
            <div id="cuttersList"></div>
            <div id="totalFieldWeightBox" style="margin:16px 0;padding:12px 0;text-align:center;font-weight:bold;border:1px solid #bbb;border-radius:8px;background:#f7f7f7;">Total field weight: <span id="totalFieldWeight">0.00</span> tons</div>
            <div style="display:flex;justify-content:center;margin:12px 0;">
              <button type="button" onclick="addCutterRow()">Add Cutter</button>
            </div>
          </div>

          <div style="display:flex;justify-content:center;margin:12px 0;">
            <button type="submit" onclick="submitTruckForm()">Submit Truck Load</button>
          </div>
        </form>
        <div id="dataCaptureStatus"></div>
      </div>
    </div>

    <div id="adminView" style="display:none;">
      <div class="centered-form">
        <h2>Admin Dashboard</h2>
        <div class="admin-dashboard-buttons">
          <button onclick="showAdminSection('truckLoads')">Truck Loads</button>
          <button onclick="showAdminSection('cutters')">Cutters</button>
          <button onclick="showAdminSection('deductions')">Deductions</button>
          <button onclick="showAdminSection('config')">Config</button>
          <button onclick="showAdminSection('reports')">Reports</button>
        </div>
        <div id="adminSectionContainer"></div>
      </div>
    </div>

    <script type="module">
      import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
      const SUPABASE_URL = 'https://zgacwkiklejtgmmmands.supabase.co';
      const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnYWN3a2lrbGVqdGdtbW1hbmRzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE1MzEzODksImV4cCI6MjA2NzEwNzM4OX0.EZ4DnfKhKjVuPISX_G5vPnUoxyOI9EOi2pH4CpO_KB0';
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      document.addEventListener('DOMContentLoaded', () => {
        updateOnlineStatusIndicator();
        loadCutterData();
        syncOfflineData();
        window.addEventListener('online', updateOnlineStatusIndicator);
        window.addEventListener('offline', updateOnlineStatusIndicator);
        window.addEventListener('online', syncOfflineData);
        updateBackToHomeBtn();
      });

      function isOnline() {
        return navigator.onLine;
      }

      function updateOnlineStatusIndicator() {
        const statusElement = document.getElementById('onlineStatus');
        const pendingCount = JSON.parse(localStorage.getItem('offlineTruckSubmissions') || '[]').length;
        if (navigator.onLine) {
          if (pendingCount > 0) {
            statusElement.textContent = `Online (${pendingCount} truck loads pending sync)`;
            statusElement.className = 'pending-sync-status';
          } else {
            statusElement.textContent = 'Online';
            statusElement.className = 'online-status';
          }
        } else {
          statusElement.textContent = `Offline (${pendingCount} truck loads pending)`;
          statusElement.className = 'offline-status';
        }
      }

      // Fetches cutter names and IDs from Supabase and populates the dropdown
      async function loadCutterData() {
        const select = document.getElementById('cutterId');
        if (!select) return;
        select.innerHTML = '<option value="">Loading Cutters...</option>';
        const { data, error } = await supabase
          .from('canecutters')
          .select('cutter_id, name, surname');
        select.innerHTML = '<option value="">Select Cutter</option>';
        if (error) {
          console.error('Error loading cutters:', error.message);
          select.innerHTML = '<option value="">Error loading cutters. Please refresh.</option>';
          alert('Error loading cutters: ' + error.message);
          return;
        }
        if (data && data.length > 0) {
          data.forEach(cutter => {
            const option = document.createElement('option');
            option.value = cutter.cutter_id;
            option.textContent = cutter.name + ' ' + cutter.surname;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">No cutters found</option>';
        }
      }

      window.submitForm = async function() {
        const date = document.getElementById('cutDate').value;
        const cutterId = document.getElementById('cutterId').value;
        const tons = document.getElementById('tonsCut').value;
        if (!date) {
          alert('Please select a Date of Cut.');
          return;
        }
        if (!cutterId) {
          alert('Please select a Cutter ID.');
          return;
        }
        if (!tons || isNaN(parseFloat(tons)) || parseFloat(tons) <= 0) {
          alert('Please enter a valid amount of Tons Cut (must be a number greater than 0).');
          return;
        }
        const submission = {
          type: 'dailyCut',
          dateOfCut: date,
          cutterId: cutterId,
          tonsCut: parseFloat(tons)
        };
        if (isOnline()) {
          // Insert into Supabase
          const { error } = await supabase.from('dailycuts').insert([
            {
              date_of_cut: submission.dateOfCut,
              cutter_id: submission.cutterId,
              tons_cut: submission.tonsCut
            }
          ]);
          if (!error) {
            alert('Daily cut recorded successfully!');
            updateOnlineStatusIndicator();
          } else {
            alert('Server error: ' + error.message + ' It has been queued for offline sync.');
            saveToOfflineQueue(submission);
            updateOnlineStatusIndicator();
          }
        } else {
          saveToOfflineQueue(submission);
          alert('Offline: Data saved locally. It will sync automatically when you are back online.');
        }
        document.getElementById('cutDate').value = '';
        document.getElementById('cutterId').value = '';
        document.getElementById('tonsCut').value = '';
        updateOnlineStatusIndicator();
      }

      function saveToOfflineQueue(item) {
        let queue = JSON.parse(localStorage.getItem('offlineSubmissions')) || [];
        queue.push(item);
        localStorage.setItem('offlineSubmissions', JSON.stringify(queue));
        updateOnlineStatusIndicator();
      }

      async function syncOfflineData() {
        if (!isOnline()) {
          console.log('Still offline, cannot sync.');
          return;
        }
        let queue = JSON.parse(localStorage.getItem('offlineSubmissions') || '[]');
        if (queue.length === 0) {
          console.log('No offline data to sync.');
          updateOnlineStatusIndicator();
          return;
        }
        console.log(`Attempting to sync ${queue.length} offline items.`);
        alert(`Attempting to sync ${queue.length} offline items...`);
        let newQueue = [];
        let syncedCount = 0;
        for (const item of queue) {
          if (item.type === 'dailyCut') {
            const { error } = await supabase.from('dailycuts').insert([
              {
                date_of_cut: item.dateOfCut,
                cutter_id: item.cutterId,
                tons_cut: item.tonsCut
              }
            ]);
            if (!error) {
              syncedCount++;
            } else {
              newQueue.push(item);
              console.error('Failed to sync item:', error.message, item);
            }
          } else {
            newQueue.push(item);
            console.error('Unknown submission type:', item);
          }
        }
        localStorage.setItem('offlineSubmissions', JSON.stringify(newQueue));
        updateOnlineStatusIndicator();
        if (syncedCount > 0) {
          alert(`Synced ${syncedCount} item(s) successfully!`);
        }
        if (newQueue.length > 0) {
          alert(`Could not sync ${newQueue.length} item(s). They remain in the offline queue.`);
        }
      }

      let cachedCutters = [];

      async function cacheCutters() {
        // Try to fetch from Supabase, else use localStorage
        let cutters = [];
        let online = navigator.onLine;
        if (online) {
          const { data, error } = await supabase.from('canecutters').select('cutter_id, name, surname');
          if (!error && data) {
            cutters = data;
            localStorage.setItem('cachedCutters', JSON.stringify(cutters));
          } else {
            cutters = JSON.parse(localStorage.getItem('cachedCutters') || '[]');
          }
        } else {
          cutters = JSON.parse(localStorage.getItem('cachedCutters') || '[]');
        }
        cachedCutters = cutters;
      }

      function renderCutterOptions(selectedId) {
        return cachedCutters.map(cutter => `<option value="${cutter.cutter_id}" ${selectedId === cutter.cutter_id ? 'selected' : ''}>${cutter.name} ${cutter.surname}</option>`).join('');
      }

      function addCutterRow(selectedId = '', weight = '') {
        const list = document.getElementById('cuttersList');
        const row = document.createElement('div');
        row.className = 'cutterRow';
        row.innerHTML = `
          <div style="display:flex;justify-content:center;">
            <select class="cutterSelect">${renderCutterOptions(selectedId)}</select>
          </div>
          <div style="display:flex;justify-content:center;">
            <input type="number" class="cutterWeight" min="0" step="0.01" placeholder="Weight (tons)" value="${weight}">
          </div>
          <div style="display:flex;justify-content:center;">
            <button type="button" onclick="this.parentNode.remove()">Remove</button>
          </div>
        `;
        list.appendChild(row);
      }

      window.addCutterRow = addCutterRow;

      async function setupDataCaptureView() {
        await cacheCutters();
        document.getElementById('cuttersList').innerHTML = '';
        addCutterRow();
        document.getElementById('cutDateTruck').value = new Date().toISOString().slice(0,10);
      }

      window.submitTruckForm = async function() {
        const truckNumber = document.getElementById('truckNumber').value.trim();
        const cutDate = document.getElementById('cutDateTruck').value;
        const fieldNumbers = document.getElementById('fieldNumbers').value.trim();
        const cutterRows = Array.from(document.querySelectorAll('#cuttersList .cutterRow'));
        const cutters = cutterRows.map(row => {
          return {
            cutter_id: row.querySelector('.cutterSelect').value,
            field_weight: parseFloat(row.querySelector('.cutterWeight').value)
          };
        }).filter(c => c.cutter_id && c.field_weight > 0);
        // Calculate total field weight
        const totalFieldWeight = cutters.reduce((sum, c) => sum + c.field_weight, 0);
        if (!truckNumber || !cutDate || !fieldNumbers || cutters.length === 0) {
          alert('Please fill in all fields and add at least one cutter with weight.');
          return;
        }
        const submission = {
          type: 'truckLoad',
          truckNumber,
          cutDate,
          fieldNumbers: fieldNumbers.split(',').map(f => f.trim()),
          cutters
        };
        if (navigator.onLine) {
          const { data, error } = await supabase.from('truck_loads').insert([
            {
              truck_number: truckNumber,
              date: cutDate,
              field_numbers: submission.fieldNumbers,
              total_field_weight: totalFieldWeight
            }
          ]).select();
          if (!error && data && data[0]) {
            const truckLoadId = data[0].id;
            const cutterInserts = submission.cutters.map(c => ({
              truck_load_id: truckLoadId,
              cutter_id: c.cutter_id,
              field_weight: c.field_weight
            }));
            const { error: cutterError } = await supabase.from('truck_cutters').insert(cutterInserts);
            if (!cutterError) {
              alert('Truck load recorded successfully!');
              setupDataCaptureView();
            } else {
              alert('Error saving cutter weights: ' + cutterError.message);
            }
          } else {
            alert('Error saving truck load: ' + (error ? error.message : 'Unknown error'));
            saveTruckToOfflineQueue(submission);
          }
        } else {
          saveTruckToOfflineQueue(submission);
          alert('Offline: Data saved locally. It will sync automatically when you are back online.');
        }
        updateDataCaptureStatus();
      }

      function saveTruckToOfflineQueue(item) {
        let queue = JSON.parse(localStorage.getItem('offlineTruckSubmissions') || '[]');
        queue.push(item);
        localStorage.setItem('offlineTruckSubmissions', JSON.stringify(queue));
        updateDataCaptureStatus();
      }

      async function syncOfflineTruckData() {
        if (!navigator.onLine) return;
        let queue = JSON.parse(localStorage.getItem('offlineTruckSubmissions') || '[]');
        if (queue.length === 0) return;
        let newQueue = [];
        for (const item of queue) {
          if (item.type === 'truckLoad') {
            const { data, error } = await supabase.from('truck_loads').insert([
              {
                truck_number: item.truckNumber,
                date: item.cutDate,
                field_numbers: item.fieldNumbers
              }
            ]).select();
            if (!error && data && data[0]) {
              const truckLoadId = data[0].id;
              const cutterInserts = item.cutters.map(c => ({
                truck_load_id: truckLoadId,
                cutter_id: c.cutter_id,
                field_weight: c.field_weight
              }));
              const { error: cutterError } = await supabase.from('truck_cutters').insert(cutterInserts);
              if (cutterError) newQueue.push(item);
            } else {
              newQueue.push(item);
            }
          } else {
            newQueue.push(item);
          }
        }
        localStorage.setItem('offlineTruckSubmissions', JSON.stringify(newQueue));
        updateDataCaptureStatus();
      }

      function updateDataCaptureStatus() {
        const statusElement = document.getElementById('dataCaptureStatus');
        const pendingCount = JSON.parse(localStorage.getItem('offlineTruckSubmissions') || '[]').length;
        if (navigator.onLine) {
          if (pendingCount > 0) {
            statusElement.textContent = `Online (${pendingCount} truck loads pending sync)`;
            statusElement.className = 'pending-sync-status';
          } else {
            statusElement.textContent = 'Online';
            statusElement.className = 'online-status';
          }
        } else {
          statusElement.textContent = `Offline (${pendingCount} truck loads pending)`;
          statusElement.className = 'offline-status';
        }
      }

      window.addEventListener('online', syncOfflineTruckData);
      window.addEventListener('online', updateDataCaptureStatus);
      window.addEventListener('offline', updateDataCaptureStatus);

      let showAdminSectionCounter = 0;
      let showAdminSectionCuttersRunning = false;
      let currentAdminSection = null;
      window.showAdminSection = async function(section) {
        if (currentAdminSection === section) {
          console.log(`[Debug] showAdminSection('${section}') called, but already on this section. Skipping re-render.`);
          return;
        }
        currentAdminSection = section;
        if (section === 'cutters') {
          if (showAdminSectionCuttersRunning) {
            console.warn('[Debug] showAdminSection("cutters") called while previous call is still running! Call stack:', new Error().stack);
            return;
          }
          showAdminSectionCuttersRunning = true;
        }
        showAdminSectionCounter++;
        const container = document.getElementById('adminSectionContainer');
        const callTime = new Date().toLocaleTimeString();
        container.innerHTML = '';
        if (section === 'truckLoads') {
          container.innerHTML = '<h3>Truck Loads</h3><div id="truckLoadsList">Loading...</div>';
          const { data, error } = await supabase.from('truck_loads').select('*').order('date', { ascending: false });
          if (error) {
            document.getElementById('truckLoadsList').innerHTML = 'Error loading truck loads.';
            return;
          }
          if (!data || data.length === 0) {
            document.getElementById('truckLoadsList').innerHTML = 'No truck loads found.';
            return;
          }
          let html = '<table><tr><th>Truck</th><th>Date</th><th>Fields</th><th>Mill Weight</th><th>Action</th></tr>';
          data.forEach(load => {
            html += `<tr>
              <td>${load.truck_number}</td>
              <td>${load.date}</td>
              <td>${(load.field_numbers || []).join(', ')}</td>
              <td>${load.mill_weight ? load.mill_weight : '<span style=\'color:red\'>Not entered</span>'}</td>
              <td><button class="config-action-btn" onclick=\"showTruckLoadDetail('${load.id}')\">View/Edit</button></td>
            </tr>`;
          });
          html += '</table>';
          document.getElementById('truckLoadsList').innerHTML = html;
        } else if (section === 'cutters') {
          let html = `<h3>Cutter Management</h3>`;
          html += `<div id="cutterFormContainer"></div>`;
          html += `<button class="config-action-btn" onclick="showAddCutterForm()">Add New Cutter</button>`;
          html += `<div id="adminCuttersList">Loading...</div>`;
          container.innerHTML = html;
          await loadCuttersList();
          showAdminSectionCuttersRunning = false;
          return;
        } else if (section === 'deductions') {
          let html = '<h3>Deductions</h3>';
          html += '<div id="deductionFormContainer"></div>';
          html += '<button class="config-action-btn" onclick="showAddDeductionForm()">Add New Deduction</button>';
          html += '<div id="deductionsList">Loading...</div>';
          container.innerHTML = html;
          loadDeductionsList();
        } else if (section === 'config') {
          let html = '<h3>Config Variables</h3>';
          html += `<div class="config-toggle-buttons">
            <button id="wageScaleBtn" class="config-toggle-btn" onclick="showConfigSection('wageScale')">Wage Scale</button>
            <button id="uifRateBtn" class="config-toggle-btn" onclick="showConfigSection('uifRate')">UIF Rate</button>
          </div>`;
          html += `<div id="wageScaleSection" class="config-section">
            <div id="wageScaleTableContainer">Loading wage scale...</div>
            <button class="config-action-btn" onclick="showAddWageBracketForm()">Add Wage Bracket</button>
            <div id="wageScaleFormContainer"></div>
          </div>`;
          html += `<div id="uifRateSection" class="config-section">
            <div id="uifRateContainer">Loading UIF rate...</div>
            <button class="config-action-btn" onclick="showEditUIFRateForm()">Edit UIF Rate</button>
            <div id="uifRateFormContainer"></div>
          </div>`;
          container.innerHTML = html;
          // Default: show wage scale
          showConfigSection('wageScale');
          loadWageScaleTable();
          loadUIFRate();
        } else if (section === 'reports') {
          let html = '<h3>Reports</h3>';
          html += '<div id="reportSummary">Loading...</div>';
          // Insert improved CSV export UI here
          html += `<div id="csvExportSection" style="margin-top:24px;">
`
            + `<div class="csv-export-group">
                <div class="csv-export-header"><b>Payroll Report</b><button class="csv-export-btn" onclick="exportPayrollCSV()">Export</button></div>
                <div class="filter-row"><span class="filter-label">From:</span><input type="date" id="payrollFrom"></div>
                <div class="filter-row"><span class="filter-label">To:</span><input type="date" id="payrollTo"></div>
              </div>
`
            + `<div class="csv-export-group">
                <div class="csv-export-header"><b>Truck Loads</b><button class="csv-export-btn" onclick="exportTruckLoadsCSV()">Export</button></div>
                <div class="filter-row"><span class="filter-label">From:</span><input type="date" id="truckLoadsFrom"></div>
                <div class="filter-row"><span class="filter-label">To:</span><input type="date" id="truckLoadsTo"></div>
              </div>
`
            + `<div class="csv-export-group">
                <div class="csv-export-header"><b>Deductions</b><button class="csv-export-btn" onclick="exportDeductionsCSV()">Export</button></div>
                <div class="filter-row"><span class="filter-label">From:</span><input type="date" id="deductionsFrom"></div>
                <div class="filter-row"><span class="filter-label">To:</span><input type="date" id="deductionsTo"></div>
                <div class="filter-row"><span class="filter-label">Cutter:</span><select id="deductionsCutter"></select></div>
              </div>
`
            + `<div class="csv-export-group">
                <div class="csv-export-header"><b>Config/Settings</b><button class="csv-export-btn" onclick="exportConfigCSV()">Export</button></div>
              </div>
`
            + `<div class="csv-export-group">
                <div class="csv-export-header"><b>Individual Cutter</b><button class="csv-export-btn" onclick="exportIndividualCutterCSV()">Export</button></div>
                <div class="filter-row"><span class="filter-label">Cutter:</span><select id="individualCutter"></select></div>
                <div class="filter-row"><span class="filter-label">From:</span><input type="date" id="individualCutterFrom"></div>
                <div class="filter-row"><span class="filter-label">To:</span><input type="date" id="individualCutterTo"></div>
              </div>
`
            + `<div class="csv-export-group">
                <div class="csv-export-header"><b>Field Productivity</b><button class="csv-export-btn" onclick="exportFieldProductivityCSV()">Export</button></div>
                <div class="filter-row"><span class="filter-label">Field:</span><select id="fieldProductivityField"></select></div>
                <div class="filter-row"><span class="filter-label">From:</span><input type="date" id="fieldProductivityFrom"></div>
                <div class="filter-row"><span class="filter-label">To:</span><input type="date" id="fieldProductivityTo"></div>
              </div>
`
            + `</div>`;
          container.innerHTML = html;
          loadReportSummary();
          populateCutterDropdowns();
          populateFieldDropdown();
        }
      }

      window.showTruckLoadDetail = async function(truckLoadId) {
        const container = document.getElementById('adminSectionContainer');
        container.innerHTML = '<h3>Truck Load Detail</h3><div>Loading...</div>';
        const { data: loadData, error: loadError } = await supabase.from('truck_loads').select('*').eq('id', truckLoadId).single();
        if (loadError || !loadData) {
          container.innerHTML = 'Error loading truck load.';
          return;
        }
        const { data: cuttersData, error: cuttersError } = await supabase.from('truck_cutters').select('*, canecutters(name, surname)').eq('truck_load_id', truckLoadId);
        if (cuttersError) {
          container.innerHTML = 'Error loading cutters.';
          return;
        }
        let html = `<div><b>Truck:</b> ${loadData.truck_number} <b>Date:</b> ${loadData.date} <b>Fields:</b> ${(loadData.field_numbers || []).join(', ')}</div>`;
        html += `<div style="display:flex;align-items:center;gap:12px;"><label for="millWeightInput">Mill Weight (tons):</label> <input type="number" id="millWeightInput" value="${loadData.mill_weight || ''}" min="0" step="0.01"> <button class="config-action-btn" onclick="saveMillWeight('${truckLoadId}')">Save</button> <button class="config-action-btn" onclick="backToTruckLoadsList()">Back to List</button></div>`;
        let totalFieldWeight = cuttersData.reduce((sum, c) => sum + (c.field_weight || 0), 0);
        let millWeight = loadData.mill_weight || 0;
        html += '<table><tr><th>Cutter</th><th>Field Weight</th><th>Adjusted Weight</th></tr>';
        cuttersData.forEach(c => {
          let adjusted = (loadData.mill_weight && totalFieldWeight > 0) ? ((c.field_weight / totalFieldWeight) * loadData.mill_weight).toFixed(2) : '-';
          html += `<tr><td>${c.canecutters ? c.canecutters.name + ' ' + c.canecutters.surname : c.cutter_id}</td><td>${c.field_weight}</td><td>${adjusted}</td></tr>`;
        });
        html += '</table>';
        container.innerHTML = html;
      }

      window.saveMillWeight = async function(truckLoadId) {
        const val = parseFloat(document.getElementById('millWeightInput').value);
        if (isNaN(val) || val <= 0) {
          alert('Please enter a valid mill weight.');
          return;
        }
        const { error } = await supabase.from('truck_loads').update({ mill_weight: val }).eq('id', truckLoadId);
        if (!error) {
          alert('Mill weight saved. Adjusted weights updated.');
          document.getElementById('adminSectionContainer').innerHTML = '';
          currentAdminSection = null;
          setTimeout(() => { showAdminSection('truckLoads'); }, 10);
        } else {
          alert('Error saving mill weight: ' + error.message);
        }
      }

      window.loadCuttersList = async function() {
        let listDiv = document.getElementById('adminCuttersList');
        listDiv.innerHTML = `<div style='color:gray;'>[Debug] Loading cutters list... (${new Date().toLocaleTimeString()})</div>`;
        const { data, error } = await supabase.from('canecutters').select('*').order('name');
        // Re-select the element after async call
        listDiv = document.getElementById('adminCuttersList');
        if (!listDiv) {
          console.error('[Debug] adminCuttersList element not found after async!');
          return;
        }
        if (error) {
          listDiv.innerHTML = 'Error loading cutters.';
          return;
        }
        if (!data || data.length === 0) {
          listDiv.innerHTML = 'No cutters found.';
          return;
        }
        // Render real cutters table
        let html = '<table border="1" style="border-collapse:collapse;width:100%;"><tr>';
        const keys = Object.keys(data[0] || {});
        keys.forEach(key => { html += `<th>${key}</th>`; });
        html += '<th>Action</th></tr>';
        data.forEach(row => {
          html += '<tr>';
          keys.forEach(key => { html += `<td>${row[key]}</td>`; });
          html += `<td><div style='display:flex;justify-content:center;'><button class="config-action-btn" onclick="showEditCutterForm('${row.id}')">Edit</button> <button class="config-action-btn" onclick="deleteCutter('${row.id}')">Delete</button></div></td>`;
          html += '</tr>';
        });
        html += '</table>';
        listDiv.innerHTML = html;
        console.log('[Debug] Set adminCuttersList to real table.');
      }

      window.showAddCutterForm = function() {
        const formDiv = document.getElementById('cutterFormContainer');
        formDiv.innerHTML = `<h4>Add New Cutter</h4>
          <form onsubmit=\"addCutter(event)\">
            <label for='newCutterId'>Cutter ID:</label><input id='newCutterId' required><br>
            <label for='newCutterName'>Name:</label><input id='newCutterName' required><br>
            <label for='newCutterSurname'>Surname:</label><input id='newCutterSurname' required><br>
            <button type='submit'>Add</button> <button type='button' onclick=\"clearCutterForm()\">Cancel</button>
          </form>`;
      }

      window.addCutter = async function(e) {
        e.preventDefault();
        const cutter_id = document.getElementById('newCutterId').value.trim();
        const name = document.getElementById('newCutterName').value.trim();
        const surname = document.getElementById('newCutterSurname').value.trim();
        if (!cutter_id || !name || !surname) {
          alert('All fields required.');
          return;
        }
        // Insert with all fields, let Supabase auto-generate uuid if needed
        const { error } = await supabase.from('canecutters').insert([{ cutter_id, name, surname }]);
        if (!error) {
          alert('Cutter added.');
          clearCutterForm();
          loadCuttersList();
          await cacheCutters();
        } else {
          alert('Error adding cutter: ' + error.message);
        }
      }

      window.showEditCutterForm = async function(id) {
        const { data, error } = await supabase.from('canecutters').select('*').eq('id', id).single();
        if (error || !data) {
          alert('Error loading cutter.');
          return;
        }
        const formDiv = document.getElementById('cutterFormContainer');
        formDiv.innerHTML = `<h4>Edit Cutter</h4>
          <form onsubmit=\"editCutter(event, '${id}')\">
            <label for='editCutterId'>Cutter ID:</label><input id='editCutterId' value='${data.cutter_id}' required><br>
            <label for='editCutterName'>Name:</label><input id='editCutterName' value='${data.name}' required><br>
            <label for='editCutterSurname'>Surname:</label><input id='editCutterSurname' value='${data.surname}' required><br>
            <button type='submit'>Save</button> <button type='button' onclick=\"clearCutterForm()\">Cancel</button>
          </form>`;
      }

      window.editCutter = async function(e, id) {
        e.preventDefault();
        const cutter_id = document.getElementById('editCutterId').value.trim();
        const name = document.getElementById('editCutterName').value.trim();
        const surname = document.getElementById('editCutterSurname').value.trim();
        if (!cutter_id || !name || !surname) {
          alert('All fields required.');
          return;
        }
        const { error } = await supabase.from('canecutters').update({ cutter_id, name, surname }).eq('id', id);
        if (!error) {
          alert('Cutter updated.');
          clearCutterForm();
          loadCuttersList();
          await cacheCutters();
        } else {
          alert('Error updating cutter: ' + error.message);
        }
      }

      window.deleteCutter = async function(id) {
        if (!confirm('Delete this cutter?')) return;
        const { error } = await supabase.from('canecutters').delete().eq('id', id);
        if (!error) {
          alert('Cutter deleted.');
          loadCuttersList();
          await cacheCutters();
        } else {
          alert('Error deleting cutter: ' + error.message);
        }
      }

      window.clearCutterForm = function() {
        document.getElementById('cutterFormContainer').innerHTML = '';
      }

      window.loadDeductionsList = async function() {
        const listDiv = document.getElementById('deductionsList');
        const { data, error } = await supabase.from('deductions').select('*, canecutters(name, surname)').order('date_of_deduction', { ascending: false });
        if (error) {
          listDiv.innerHTML = 'Error loading deductions.';
          return;
        }
        if (!data || data.length === 0) {
          listDiv.innerHTML = 'No deductions found.';
          return;
        }
        let html = '<table><tr><th>Date</th><th>Cutter</th><th>Type</th><th>Amount</th><th>Reason</th><th>Action</th></tr>';
        data.forEach(ded => {
          html += `<tr><td>${ded.date_of_deduction}</td><td>${ded.canecutters ? ded.canecutters.name + ' ' + ded.canecutters.surname : ded.cutter_id}</td><td>${ded.deduction_type}</td><td>${ded.amount}</td><td>${ded.reason || ''}</td><td><button class="config-action-btn" onclick="showEditDeductionForm('${ded.id}')">Edit</button> <button class="config-action-btn" onclick="deleteDeduction('${ded.id}')">Delete</button></td></tr>`;
        });
        html += '</table>';
        listDiv.innerHTML = html;
      }

      window.showAddDeductionForm = function() {
        const formDiv = document.getElementById('deductionFormContainer');
        formDiv.innerHTML = `<h4>Add New Deduction</h4>
          <form onsubmit=\"addDeduction(event)\">
            <label for='deductionDate'>Date:</label><input id='deductionDate' type='date' required><br>
            <label for='deductionCutter'>Cutter:</label><select id='deductionCutter'>${renderCutterOptions('')}</select><br>
            <label for='deductionType'>Type:</label><input id='deductionType' required><br>
            <label for='deductionAmount'>Amount:</label><input id='deductionAmount' type='number' step='0.01' required><br>
            <label for='deductionReason'>Reason:</label><input id='deductionReason'><br>
            <button type='submit'>Add</button> <button type='button' onclick=\"clearDeductionForm()\">Cancel</button>
          </form>`;
      }

      window.addDeduction = async function(e) {
        e.preventDefault();
        const date_of_deduction = document.getElementById('deductionDate').value;
        const cutter_id = document.getElementById('deductionCutter').value;
        const deduction_type = document.getElementById('deductionType').value.trim();
        const amount = parseFloat(document.getElementById('deductionAmount').value);
        const reason = document.getElementById('deductionReason').value.trim();
        if (!date_of_deduction || !cutter_id || !deduction_type || isNaN(amount)) {
          alert('All fields except reason are required.');
          return;
        }
        const { error } = await supabase.from('deductions').insert([{ date_of_deduction, cutter_id, deduction_type, amount, reason }]);
        if (!error) {
          alert('Deduction added.');
          clearDeductionForm();
          loadDeductionsList();
        } else {
          alert('Error adding deduction: ' + error.message);
        }
      }

      window.showEditDeductionForm = async function(id) {
        const { data, error } = await supabase.from('deductions').select('*').eq('id', id).single();
        if (error || !data) {
          alert('Error loading deduction.');
          return;
        }
        const formDiv = document.getElementById('deductionFormContainer');
        formDiv.innerHTML = `<h4>Edit Deduction</h4>
          <form onsubmit=\"editDeduction(event, '${id}')\">
            <label for='editDeductionDate'>Date:</label><input id='editDeductionDate' type='date' value='${data.date_of_deduction}' required><br>
            <label for='editDeductionCutter'>Cutter:</label><select id='editDeductionCutter'>${renderCutterOptions(data.cutter_id)}</select><br>
            <label for='editDeductionType'>Type:</label><input id='editDeductionType' value='${data.deduction_type}' required><br>
            <label for='editDeductionAmount'>Amount:</label><input id='editDeductionAmount' type='number' step='0.01' value='${data.amount}' required><br>
            <label for='editDeductionReason'>Reason:</label><input id='editDeductionReason' value='${data.reason || ''}'><br>
            <button type='submit'>Save</button> <button type='button' onclick=\"clearDeductionForm()\">Cancel</button>
          </form>`;
      }

      window.editDeduction = async function(e, id) {
        e.preventDefault();
        const date_of_deduction = document.getElementById('editDeductionDate').value;
        const cutter_id = document.getElementById('editDeductionCutter').value;
        const deduction_type = document.getElementById('editDeductionType').value.trim();
        const amount = parseFloat(document.getElementById('editDeductionAmount').value);
        const reason = document.getElementById('editDeductionReason').value.trim();
        if (!date_of_deduction || !cutter_id || !deduction_type || isNaN(amount)) {
          alert('All fields except reason are required.');
          return;
        }
        const { error } = await supabase.from('deductions').update({ date_of_deduction, cutter_id, deduction_type, amount, reason }).eq('id', id);
        if (!error) {
          alert('Deduction updated.');
          clearDeductionForm();
          loadDeductionsList();
        } else {
          alert('Error updating deduction: ' + error.message);
        }
      }

      window.deleteDeduction = async function(id) {
        if (!confirm('Delete this deduction?')) return;
        const { error } = await supabase.from('deductions').delete().eq('id', id);
        if (!error) {
          alert('Deduction deleted.');
          loadDeductionsList();
        } else {
          alert('Error deleting deduction: ' + error.message);
        }
      }

      window.clearDeductionForm = function() {
        document.getElementById('deductionFormContainer').innerHTML = '';
      }

      window.loadConfigList = async function() {
        const listDiv = document.getElementById('configList');
        const { data, error } = await supabase.from('config').select('*').order('key');
        if (error) {
          listDiv.innerHTML = 'Error loading config variables.';
          return;
        }
        if (!data || data.length === 0) {
          listDiv.innerHTML = 'No config variables found.';
          return;
        }
        let html = '<table><tr><th>Key</th><th>Value</th><th>Action</th></tr>';
        data.forEach(cfg => {
          html += `<tr><td>${cfg.key}</td><td>${cfg.value}</td><td><button onclick=\"showEditConfigForm('${cfg.id}')\">Edit</button> <button onclick=\"deleteConfig('${cfg.id}')\">Delete</button></td></tr>`;
        });
        html += '</table>';
        listDiv.innerHTML = html;
      }

      window.showAddConfigForm = function() {
        const formDiv = document.getElementById('configFormContainer');
        formDiv.innerHTML = `<h4>Add New Config Variable</h4>
          <form onsubmit=\"addConfig(event)\">
            <label for='newConfigKey'>Key:</label><input id='newConfigKey' required><br>
            <label for='newConfigValue'>Value:</label><input id='newConfigValue' required><br>
            <button type='submit'>Add</button> <button type='button' onclick=\"clearConfigForm()\">Cancel</button>
          </form>`;
      }

      window.addConfig = async function(e) {
        e.preventDefault();
        const key = document.getElementById('newConfigKey').value.trim();
        const value = document.getElementById('newConfigValue').value.trim();
        if (!key || !value) {
          alert('All fields required.');
          return;
        }
        const { error } = await supabase.from('config').insert([{ key, value }]);
        if (!error) {
          alert('Config variable added.');
          clearConfigForm();
          loadConfigList();
        } else {
          alert('Error adding config variable: ' + error.message);
        }
      }

      window.showEditConfigForm = async function(id) {
        const { data, error } = await supabase.from('config').select('*').eq('id', id).single();
        if (error || !data) {
          alert('Error loading config variable.');
          return;
        }
        const formDiv = document.getElementById('configFormContainer');
        formDiv.innerHTML = `<h4>Edit Config Variable</h4>
          <form onsubmit=\"editConfig(event, '${id}')\">
            <label for='editConfigKey'>Key:</label><input id='editConfigKey' value='${data.key}' required><br>
            <label for='editConfigValue'>Value:</label><input id='editConfigValue' value='${data.value}' required><br>
            <button type='submit'>Save</button> <button type='button' onclick=\"clearConfigForm()\">Cancel</button>
          </form>`;
      }

      window.editConfig = async function(e, id) {
        e.preventDefault();
        const key = document.getElementById('editConfigKey').value.trim();
        const value = document.getElementById('editConfigValue').value.trim();
        if (!key || !value) {
          alert('All fields required.');
          return;
        }
        const { error } = await supabase.from('config').update({ key, value }).eq('id', id);
        if (!error) {
          alert('Config variable updated.');
          clearConfigForm();
          loadConfigList();
        } else {
          alert('Error updating config variable: ' + error.message);
        }
      }

      window.deleteConfig = async function(id) {
        if (!confirm('Delete this config variable?')) return;
        const { error } = await supabase.from('config').delete().eq('id', id);
        if (!error) {
          alert('Config variable deleted.');
          loadConfigList();
        } else {
          alert('Error deleting config variable: ' + error.message);
        }
      }

      window.clearConfigForm = function() {
        document.getElementById('configFormContainer').innerHTML = '';
      }

      window.loadReportSummary = async function() {
        const reportDiv = document.getElementById('reportSummary');
        // Aggregate total field and adjusted weights per cutter
        const { data: cutters, error: cuttersError } = await supabase.from('canecutters').select('*');
        const { data: truckCutters, error: tcError } = await supabase.from('truck_cutters').select('*, truck_loads(mill_weight)').order('cutter_id');
        // Map cutter_id to name
        const cutterMap = {};
        cutters.forEach(c => { cutterMap[c.cutter_id] = c.name + ' ' + c.surname; });
        // Aggregate
        const summary = {};
        truckCutters.forEach(tc => {
          if (!summary[tc.cutter_id]) summary[tc.cutter_id] = { field: 0, adjusted: 0 };
          summary[tc.cutter_id].field += tc.field_weight || 0;
          if (tc.truck_loads && tc.truck_loads.mill_weight && tc.field_weight) {
            // Need total field weight for this truck
            // We'll sum all field_weights for this truck_load_id
            const totalFieldWeight = truckCutters.filter(x => x.truck_load_id === tc.truck_load_id).reduce((sum, x) => sum + (x.field_weight || 0), 0);
            if (totalFieldWeight > 0) {
              summary[tc.cutter_id].adjusted += (tc.field_weight / totalFieldWeight) * tc.truck_loads.mill_weight;
            }
          }
        });
        let html = '<table><tr><th>Cutter</th><th>Total Field Weight</th><th>Total Adjusted Weight</th></tr>';
        Object.keys(summary).forEach(cid => {
          html += `<tr><td>${cutterMap[cid] || cid}</td><td>${summary[cid].field.toFixed(2)}</td><td>${summary[cid].adjusted.toFixed(2)}</td></tr>`;
        });
        html += '</table>';
        reportDiv.innerHTML = html;
      }

      window.exportReportCSV = async function() {
        // Reuse the summary logic
        const { data: cutters } = await supabase.from('canecutters').select('*');
        const { data: truckCutters } = await supabase.from('truck_cutters').select('*, truck_loads(mill_weight)').order('cutter_id');
        const cutterMap = {};
        cutters.forEach(c => { cutterMap[c.cutter_id] = c.name + ' ' + c.surname; });
        const summary = {};
        truckCutters.forEach(tc => {
          if (!summary[tc.cutter_id]) summary[tc.cutter_id] = { field: 0, adjusted: 0 };
          summary[tc.cutter_id].field += tc.field_weight || 0;
          if (tc.truck_loads && tc.truck_loads.mill_weight && tc.field_weight) {
            const totalFieldWeight = truckCutters.filter(x => x.truck_load_id === tc.truck_load_id).reduce((sum, x) => sum + (x.field_weight || 0), 0);
            if (totalFieldWeight > 0) {
              summary[tc.cutter_id].adjusted += (tc.field_weight / totalFieldWeight) * tc.truck_loads.mill_weight;
            }
          }
        });
        let csv = 'Cutter,Total Field Weight,Total Adjusted Weight\n';
        Object.keys(summary).forEach(cid => {
          csv += `"${cutterMap[cid] || cid}",${summary[cid].field.toFixed(2)},${summary[cid].adjusted.toFixed(2)}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'cane_payroll_report.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function updateBackToHomeBtn() {
        const btn = document.getElementById('backToHomeBtn');
        const landing = document.getElementById('landingView');
        if (landing.style.display === '' || landing.style.display === 'block') {
          btn.style.display = 'none';
        } else {
          btn.style.display = '';
        }
      }

      // Place navigation and back button logic here so it is always available
      window.showLanding = function() {
        document.getElementById('landingView').style.display = '';
        document.getElementById('dataCaptureView').style.display = 'none';
        document.getElementById('adminView').style.display = 'none';
        updateBackToHomeBtn();
      }
      window.showDataCapture = async function() {
        document.getElementById('landingView').style.display = 'none';
        document.getElementById('dataCaptureView').style.display = '';
        document.getElementById('adminView').style.display = 'none';
        updateBackToHomeBtn();
        await setupDataCaptureView();
        updateBackToHomeBtn();
      }
      window.showAdmin = function() {
        document.getElementById('landingView').style.display = 'none';
        document.getElementById('dataCaptureView').style.display = 'none';
        document.getElementById('adminView').style.display = '';
        updateBackToHomeBtn();
      }
      // Show landing view by default
      window.showLanding();

      // Attach all UI functions to window for global access
      window.showAdminSection = showAdminSection;
      window.loadCuttersList = loadCuttersList;
      window.showAddCutterForm = showAddCutterForm;
      window.addCutter = addCutter;
      window.showEditCutterForm = showEditCutterForm;
      window.editCutter = editCutter;
      window.deleteCutter = deleteCutter;
      window.clearCutterForm = clearCutterForm;

      // Add JS to update total field weight live
      function updateTotalFieldWeight() {
        const rows = document.querySelectorAll('#cuttersList .cutterRow');
        let total = 0;
        rows.forEach(row => {
          const input = row.querySelector('.cutterWeight');
          if (input && input.value) {
            const val = parseFloat(input.value);
            if (!isNaN(val)) total += val;
          }
        });
        document.getElementById('totalFieldWeight').textContent = total.toFixed(2);
      }
      // Attach event listeners to update total when weights change
      function attachWeightListeners() {
        const list = document.getElementById('cuttersList');
        list.addEventListener('input', function(e) {
          if (e.target.classList.contains('cutterWeight')) updateTotalFieldWeight();
        });
      }
      document.addEventListener('DOMContentLoaded', attachWeightListeners);
      // Also call updateTotalFieldWeight after adding/removing rows
      const origAddCutterRow = window.addCutterRow;
      window.addCutterRow = function(...args) {
        origAddCutterRow.apply(this, args);
        updateTotalFieldWeight();
      };
      // Patch remove button to update total
      document.addEventListener('click', function(e) {
        if (e.target && e.target.tagName === 'BUTTON' && e.target.textContent === 'Remove') {
          setTimeout(updateTotalFieldWeight, 0);
        }
      });

      // --- CSV Export Filter Dropdown Population ---
      async function populateCutterDropdowns() {
        const { data, error } = await supabase.from('canecutters').select('cutter_id, name, surname');
        const options = data && data.length ? data.map(c => `<option value="${c.cutter_id}">${c.name} ${c.surname}</option>`).join('') : '';
        const cutterSelects = [
          document.getElementById('deductionsCutter'),
          document.getElementById('individualCutter')
        ];
        cutterSelects.forEach(sel => {
          if (sel) {
            sel.innerHTML = '<option value="">All</option>' + options;
          }
        });
      }
      async function populateFieldDropdown() {
        const { data, error } = await supabase.from('truck_loads').select('field_numbers');
        const fields = new Set();
        if (data && data.length) {
          data.forEach(row => {
            (row.field_numbers || []).forEach(f => fields.add(f));
          });
        }
        const fieldSelect = document.getElementById('fieldProductivityField');
        if (fieldSelect) {
          fieldSelect.innerHTML = '<option value="">All</option>' + Array.from(fields).map(f => `<option value="${f}">${f}</option>`).join('');
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        populateCutterDropdowns();
        populateFieldDropdown();
      });
      // --- CSV Export Logic ---
      function downloadCSV(filename, csv) {
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      window.exportPayrollCSV = async function() {
        const from = document.getElementById('payrollFrom').value;
        const to = document.getElementById('payrollTo').value;
        // Get all cutters
        const { data: cutters } = await supabase.from('canecutters').select('*');
        // Get all truck_cutters with truck_loads (mill_weight, date) in range
        let { data: truckCutters } = await supabase.from('truck_cutters').select('*, truck_loads(date, mill_weight)').order('cutter_id');
        if (from) truckCutters = truckCutters.filter(tc => tc.truck_loads && tc.truck_loads.date >= from);
        if (to) truckCutters = truckCutters.filter(tc => tc.truck_loads && tc.truck_loads.date <= to);
        // Get all deductions in range
        let { data: deductions } = await supabase.from('deductions').select('*');
        if (from) deductions = deductions.filter(d => d.date_of_deduction >= from);
        if (to) deductions = deductions.filter(d => d.date_of_deduction <= to);
        // Map cutter_id to name
        const cutterMap = {};
        cutters.forEach(c => { cutterMap[c.cutter_id] = c.name + ' ' + c.surname; });
        // Aggregate
        const summary = {};
        truckCutters.forEach(tc => {
          if (!summary[tc.cutter_id]) summary[tc.cutter_id] = { field: 0, adjusted: 0 };
          summary[tc.cutter_id].field += tc.field_weight || 0;
          if (tc.truck_loads && tc.truck_loads.mill_weight && tc.field_weight) {
            const totalFieldWeight = truckCutters.filter(x => x.truck_load_id === tc.truck_load_id).reduce((sum, x) => sum + (x.field_weight || 0), 0);
            if (totalFieldWeight > 0) {
              summary[tc.cutter_id].adjusted += (tc.field_weight / totalFieldWeight) * tc.truck_loads.mill_weight;
            }
          }
        });
        // Deductions per cutter
        const deductionMap = {};
        deductions.forEach(d => {
          if (!deductionMap[d.cutter_id]) deductionMap[d.cutter_id] = 0;
          deductionMap[d.cutter_id] += d.amount || 0;
        });
        // CSV
        let csv = 'Cutter,Total Field Weight,Total Adjusted Weight,Total Deductions\n';
        Object.keys(summary).forEach(cid => {
          csv += `"${cutterMap[cid] || cid}",${summary[cid].field.toFixed(2)},${summary[cid].adjusted.toFixed(2)},${(deductionMap[cid]||0).toFixed(2)}\n`;
        });
        downloadCSV(`payroll_report_${from||'all'}_${to||'all'}.csv`, csv);
      };

      window.exportTruckLoadsCSV = async function() {
        const from = document.getElementById('truckLoadsFrom').value;
        const to = document.getElementById('truckLoadsTo').value;
        let { data } = await supabase.from('truck_loads').select('*').order('date');
        if (from) data = data.filter(row => row.date >= from);
        if (to) data = data.filter(row => row.date <= to);
        let csv = 'Truck Number,Date,Field Numbers,Total Field Weight,Mill Weight\n';
        data.forEach(row => {
          csv += `"${row.truck_number}",${row.date},"${(row.field_numbers||[]).join(', ')}",${row.total_field_weight||''},${row.mill_weight||''}\n`;
        });
        downloadCSV(`truck_loads_${from||'all'}_${to||'all'}.csv`, csv);
      };

      window.exportDeductionsCSV = async function() {
        const from = document.getElementById('deductionsFrom').value;
        const to = document.getElementById('deductionsTo').value;
        const cutter = document.getElementById('deductionsCutter').value;
        let { data } = await supabase.from('deductions').select('*, canecutters(name, surname)').order('date_of_deduction');
        if (from) data = data.filter(row => row.date_of_deduction >= from);
        if (to) data = data.filter(row => row.date_of_deduction <= to);
        if (cutter) data = data.filter(row => row.cutter_id === cutter);
        let csv = 'Date,Cutter,Deduction Type,Amount,Reason\n';
        data.forEach(row => {
          const cutterName = row.canecutters ? row.canecutters.name + ' ' + row.canecutters.surname : row.cutter_id;
          csv += `${row.date_of_deduction},"${cutterName}",${row.deduction_type},${row.amount},"${row.reason||''}"\n`;
        });
        downloadCSV(`deductions_${from||'all'}_${to||'all'}_${cutter||'all'}.csv`, csv);
      };

      window.exportConfigCSV = async function() {
        let { data } = await supabase.from('config').select('*').order('key');
        let csv = 'Key,Value\n';
        data.forEach(row => {
          csv += `"${row.key}","${row.value}"\n`;
        });
        downloadCSV('config_settings.csv', csv);
      };

      window.exportIndividualCutterCSV = async function() {
        const cutter = document.getElementById('individualCutter').value;
        const from = document.getElementById('individualCutterFrom').value;
        const to = document.getElementById('individualCutterTo').value;
        if (!cutter) { alert('Please select a cutter.'); return; }
        let { data } = await supabase.from('truck_cutters').select('*, truck_loads(date, field_numbers, mill_weight)').eq('cutter_id', cutter).order('id');
        if (from) data = data.filter(row => row.truck_loads && row.truck_loads.date >= from);
        if (to) data = data.filter(row => row.truck_loads && row.truck_loads.date <= to);
        let csv = 'Date,Truck Number,Field Numbers,Field Weight,Adjusted Weight,Mill Weight\n';
        data.forEach(row => {
          csv += `${row.truck_loads ? row.truck_loads.date : ''},${row.truck_loads ? row.truck_loads.truck_number : ''},"${row.truck_loads ? (row.truck_loads.field_numbers||[]).join(', ') : ''}",${row.field_weight||''},${row.adj_weight||''},${row.truck_loads ? row.truck_loads.mill_weight||'' : ''}\n`;
        });
        downloadCSV(`individual_cutter_${cutter}_${from||'all'}_${to||'all'}.csv`, csv);
      };

      window.exportFieldProductivityCSV = async function() {
        const field = document.getElementById('fieldProductivityField').value;
        const from = document.getElementById('fieldProductivityFrom').value;
        const to = document.getElementById('fieldProductivityTo').value;
        let { data } = await supabase.from('truck_loads').select('*').order('date');
        if (from) data = data.filter(row => row.date >= from);
        if (to) data = data.filter(row => row.date <= to);
        if (field) data = data.filter(row => (row.field_numbers||[]).includes(field));
        let csv = 'Field,Date,Total Tons Cut,Number of Cutters,Average Tons per Cutter\n';
        data.forEach(row => {
          const numCutters = row.total_field_weight && row.total_field_weight > 0 && row.mill_weight ? row.total_field_weight/row.mill_weight : '';
          csv += `"${(row.field_numbers||[]).join(', ')}",${row.date},${row.total_field_weight||''},${row.num_cutters||''},${row.avg_tons_per_cutter||''}\n`;
        });
        downloadCSV(`field_productivity_${field||'all'}_${from||'all'}_${to||'all'}.csv`, csv);
      };

      // Add JS functions for toggling config sections
      window.showConfigSection = function(which) {
        document.getElementById('wageScaleBtn').classList.toggle('active', which === 'wageScale');
        document.getElementById('uifRateBtn').classList.toggle('active', which === 'uifRate');
        document.getElementById('wageScaleSection').classList.toggle('active', which === 'wageScale');
        document.getElementById('uifRateSection').classList.toggle('active', which === 'uifRate');
      };

      // Add JS functions for loading wage scale and UIF rate
      window.loadWageScaleTable = async function() {
        const wageScaleContainer = document.getElementById('wageScaleTableContainer');
        wageScaleContainer.innerHTML = '<div style="color:gray;">Loading wage scale...</div>';
        const { data, error } = await supabase.from('wage_scale').select('*').order('min_tons');
        if (error) {
          wageScaleContainer.innerHTML = 'Error loading wage scale: ' + error.message;
          return;
        }
        if (!data || data.length === 0) {
          wageScaleContainer.innerHTML = '<div class="wage-scale-empty-message">No wage scale brackets found. Add one to get started.</div>';
          return;
        }
        let html = '<table border="1" style="border-collapse:collapse;width:100%;"><tr>';
        const keys = Object.keys(data[0] || {});
        keys.forEach(key => { html += `<th>${key}</th>`; });
        html += '<th>Action</th></tr>';
        data.forEach(row => {
          html += '<tr>';
          keys.forEach(key => { html += `<td>${row[key]}</td>`; });
          html += `<td><div style='display:flex;justify-content:center;'><button onclick="showEditWageBracketForm('${row.id}')">Edit</button> <button onclick="deleteWageBracket('${row.id}')">Delete</button></div></td>`;
          html += '</tr>';
        });
        html += '</table>';
        wageScaleContainer.innerHTML = html;
      };

      window.showAddWageBracketForm = function() {
        const formDiv = document.getElementById('wageScaleFormContainer');
        formDiv.innerHTML = `<h4>Add New Wage Bracket</h4>
          <form onsubmit="addWageBracket(event)">
            <label for='newMinTons'>Minimum Tons:</label><input id='newMinTons' type='number' step='0.01' required><br>
            <label for='newMaxTons'>Maximum Tons:</label><input id='newMaxTons' type='number' step='0.01' required><br>
            <label for='newRate'>Rate (Rands/Ton):</label><input id='newRate' type='number' step='0.01' required><br>
            <button type='submit'>Add</button> <button type='button' onclick="clearWageBracketForm()">Cancel</button>
          </form>`;
      }

      window.addWageBracket = async function(e) {
        e.preventDefault();
        const minTons = parseFloat(document.getElementById('newMinTons').value);
        const maxTons = parseFloat(document.getElementById('newMaxTons').value);
        const rate = parseFloat(document.getElementById('newRate').value);
        if (isNaN(minTons) || isNaN(maxTons) || isNaN(rate) || minTons < 0 || maxTons < minTons) {
          alert('Please enter valid numbers for Min Tons, Max Tons, and Rate.');
          return;
        }
        const { error } = await supabase.from('wage_scale').insert([{ min_tons: minTons, max_tons: maxTons, rate: rate }]);
        if (!error) {
          alert('Wage bracket added.');
          clearWageBracketForm();
          loadWageScaleTable();
        } else {
          alert('Error adding wage bracket: ' + error.message);
        }
      }

      window.showEditWageBracketForm = async function(id) {
        const { data, error } = await supabase.from('wage_scale').select('*').eq('id', id).single();
        if (error || !data) {
          alert('Error loading wage bracket.');
          return;
        }
        const formDiv = document.getElementById('wageScaleFormContainer');
        formDiv.innerHTML = `<h4>Edit Wage Bracket</h4>
          <form onsubmit="editWageBracket(event, '${id}')">
            <label for='editMinTons'>Minimum Tons:</label><input id='editMinTons' type='number' step='0.01' value='${data.min_tons}' required><br>
            <label for='editMaxTons'>Maximum Tons:</label><input id='editMaxTons' type='number' step='0.01' value='${data.max_tons}' required><br>
            <label for='editRate'>Rate (Rands/Ton):</label><input id='editRate' type='number' step='0.01' value='${data.rate}' required><br>
            <button type='submit'>Save</button> <button type='button' onclick="clearWageBracketForm()">Cancel</button>
          </form>`;
      }

      window.editWageBracket = async function(e, id) {
        e.preventDefault();
        const minTons = parseFloat(document.getElementById('editMinTons').value);
        const maxTons = parseFloat(document.getElementById('editMaxTons').value);
        const rate = parseFloat(document.getElementById('editRate').value);
        if (isNaN(minTons) || isNaN(maxTons) || isNaN(rate) || minTons < 0 || maxTons < minTons) {
          alert('Please enter valid numbers for Min Tons, Max Tons, and Rate.');
          return;
        }
        const { error } = await supabase.from('wage_scale').update({ min_tons: minTons, max_tons: maxTons, rate: rate }).eq('id', id);
        if (!error) {
          alert('Wage bracket updated.');
          clearWageBracketForm();
          loadWageScaleTable();
        } else {
          alert('Error updating wage bracket: ' + error.message);
        }
      }

      window.deleteWageBracket = async function(id) {
        if (!confirm('Delete this wage bracket?')) return;
        const { error } = await supabase.from('wage_scale').delete().eq('id', id);
        if (!error) {
          alert('Wage bracket deleted.');
          loadWageScaleTable();
        } else {
          alert('Error deleting wage bracket: ' + error.message);
        }
      }

      window.clearWageBracketForm = function() {
        document.getElementById('wageScaleFormContainer').innerHTML = '';
      }

      window.loadUIFRate = async function() {
        const uifRateContainer = document.getElementById('uifRateContainer');
        uifRateContainer.innerHTML = '<div style="color:gray;">Loading UIF rate...</div>';
        const { data, error } = await supabase.from('uif_rate').select('*').single();
        if (error) {
          uifRateContainer.innerHTML = 'Error loading UIF rate: ' + error.message;
          return;
        }
        if (!data) {
          uifRateContainer.innerHTML = 'No UIF rate found. Add one to get started.';
          return;
        }
        uifRateContainer.innerHTML = `<div><b>UIF Rate:</b> ${data.rate.toFixed(2)} Rands/Ton</div>`;
      };

      window.showEditUIFRateForm = async function() {
        const uifRateContainer = document.getElementById('uifRateContainer');
        uifRateContainer.innerHTML = '<div style="color:gray;">Loading UIF rate...</div>';
        const { data, error } = await supabase.from('uif_rate').select('*').single();
        if (error || !data) {
          uifRateContainer.innerHTML = 'Error loading UIF rate.';
          return;
        }
        const formDiv = document.getElementById('uifRateFormContainer');
        formDiv.innerHTML = `<h4>Edit UIF Rate</h4>
          <form onsubmit="editUIFRate(event, '${data.id}')">
            <label for='editUIFRate'>Rate (Rands/Ton):</label><input id='editUIFRate' type='number' step='0.01' value='${data.rate}' required><br>
            <button type='submit'>Save</button> <button type='button' onclick="clearUIFRateForm()">Cancel</button>
          </form>`;
      }

      window.editUIFRate = async function(e, id) {
        e.preventDefault();
        const rate = parseFloat(document.getElementById('editUIFRate').value);
        if (isNaN(rate) || rate < 0) {
          alert('Please enter a valid UIF rate (must be a number greater than or equal to 0).');
          return;
        }
        const { error } = await supabase.from('uif_rate').update({ rate: rate }).eq('id', id);
        if (!error) {
          alert('UIF rate updated.');
          clearUIFRateForm();
          loadUIFRate();
        } else {
          alert('Error updating UIF rate: ' + error.message);
        }
      }

      window.clearUIFRateForm = function() {
        document.getElementById('uifRateFormContainer').innerHTML = '';
      }

      window.backToTruckLoadsList = function() {
        document.getElementById('adminSectionContainer').innerHTML = '';
        currentAdminSection = null;
        setTimeout(() => { showAdminSection('truckLoads'); }, 10);
      }
    </script>
    <script>
      // Register service worker for offline/PWA support
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('./service-worker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
  </body>
</html> 